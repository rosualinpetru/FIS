<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HolidayService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ToM</a> &gt; <a href="index.source.html" class="el_package">ro.go.redhomeserver.tom.services</a> &gt; <span class="el_source">HolidayService.java</span></div><h1>HolidayService.java</h1><pre class="source lang-java linenums">package ro.go.redhomeserver.tom.services;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.MailException;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;
import ro.go.redhomeserver.tom.emails.HolidayStatusUpdateEmail;
import ro.go.redhomeserver.tom.enums.RequestStatus;
import ro.go.redhomeserver.tom.enums.RequestType;
import ro.go.redhomeserver.tom.exceptions.NotEnoughDaysException;
import ro.go.redhomeserver.tom.exceptions.SystemException;
import ro.go.redhomeserver.tom.exceptions.UserNotFoundException;
import ro.go.redhomeserver.tom.models.Account;
import ro.go.redhomeserver.tom.models.HolidayRequest;
import ro.go.redhomeserver.tom.models.UploadedFile;
import ro.go.redhomeserver.tom.repositories.AccountRepository;
import ro.go.redhomeserver.tom.repositories.HolidayRequestRepository;

import java.io.IOException;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Optional;

@Service
public class HolidayService {

    private final EmailService emailService;
    private final AccountRepository accountRepository;
    private final HolidayRequestRepository holidayRequestRepository;
    private final UploadedFileService uploadedFileService;

    @Autowired
<span class="fc" id="L37">    public HolidayService(EmailService emailService, AccountRepository accountRepository, HolidayRequestRepository holidayRequestRepository, UploadedFileService uploadedFileService) {</span>
<span class="fc" id="L38">        this.emailService = emailService;</span>
<span class="fc" id="L39">        this.accountRepository = accountRepository;</span>
<span class="fc" id="L40">        this.holidayRequestRepository = holidayRequestRepository;</span>
<span class="fc" id="L41">        this.uploadedFileService = uploadedFileService;</span>
<span class="fc" id="L42">    }</span>

    public HolidayRequest addHolidayRequest(String username, Map&lt;String, String&gt; params, MultipartFile file) throws IOException, NotEnoughDaysException, UserNotFoundException, ParseException {
<span class="fc" id="L45">        Optional&lt;Account&gt; accountOptional = accountRepository.findByUsername(username);</span>
<span class="fc bfc" id="L46" title="All 2 branches covered.">        if (accountOptional.isPresent()) {</span>
            Date start_date;
            Date end_date;

<span class="fc" id="L50">            DateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);</span>
<span class="fc" id="L51">            start_date = format.parse(params.get(&quot;startDate&quot;));</span>
<span class="fc" id="L52">            end_date = format.parse(params.get(&quot;endDate&quot;));</span>

            Account delegate;

<span class="fc bfc" id="L56" title="All 2 branches covered.">            if (params.get(&quot;delegateId&quot;) == null)</span>
<span class="fc" id="L57">                delegate = null;</span>
            else
<span class="fc" id="L59">                delegate = accountRepository.findById(params.get(&quot;delegateId&quot;)).orElse(null);</span>

<span class="fc" id="L61">            HolidayRequest newHolidayRequest = new HolidayRequest(</span>
<span class="fc" id="L62">                    RequestType.valueOf(params.get(&quot;requestTypeId&quot;)),</span>
                    RequestStatus.sentTL,
<span class="fc" id="L64">                    params.get(&quot;description&quot;),</span>
                    start_date,
                    end_date,
<span class="fc" id="L67">                    accountOptional.get(),</span>
                    delegate
            );

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">            if (newHolidayRequest.getRequester().getTeamLeader() == null) {</span>
<span class="fc" id="L72">                newHolidayRequest.setStatus(RequestStatus.accTl);</span>
            }

<span class="fc bfc" id="L75" title="All 2 branches covered.">            if (newHolidayRequest.getType() == RequestType.Rel) {</span>
<span class="fc" id="L76">                Account account = newHolidayRequest.getRequester();</span>
<span class="fc" id="L77">                int remainingDays = account.getRemainingDays();</span>
<span class="fc" id="L78">                int workDays = newHolidayRequest.getWorkingDays();</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">                if (remainingDays - workDays &lt; 0) {</span>
<span class="fc" id="L80">                    throw new NotEnoughDaysException(&quot;Sorry! Not enough vacation days&quot;);</span>
                }
<span class="fc" id="L82">                account.setRemainingDays(remainingDays - workDays);</span>
<span class="fc" id="L83">                accountRepository.save(account);</span>
            }

<span class="fc bfc" id="L86" title="All 2 branches covered.">            if (RequestType.valueOf(params.get(&quot;requestTypeId&quot;)) == RequestType.Med) {</span>
<span class="fc" id="L87">                uploadedFileService.storeFile(file, newHolidayRequest);</span>
            }

<span class="fc" id="L90">            return holidayRequestRepository.save(newHolidayRequest);</span>
        } else
<span class="fc" id="L92">            throw new UserNotFoundException(&quot;User &quot; + username + &quot;was not found!&quot;);</span>
    }

    public HolidayRequest updateStatusOfHolidayRequest(String holidayRequestId, String action) throws SystemException {
<span class="fc" id="L96">        Optional&lt;HolidayRequest&gt; requestOptional = holidayRequestRepository.findById(holidayRequestId);</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (requestOptional.isPresent()) {</span>
<span class="fc" id="L98">            String actionEmail = &quot;&quot;;</span>
<span class="fc" id="L99">            HolidayRequest request = requestOptional.get();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">            if (action.equals(&quot;acc&quot;)) {</span>
<span class="fc" id="L101">                request.setStatus(RequestStatus.accTl);</span>
<span class="fc" id="L102">                actionEmail = &quot;accepted&quot;;</span>
            }


<span class="fc bfc" id="L106" title="All 2 branches covered.">            if (action.equals(&quot;dec&quot;)) {</span>
<span class="fc" id="L107">                request.setStatus(RequestStatus.decTL);</span>
<span class="fc" id="L108">                Account account = request.getRequester();</span>
<span class="fc" id="L109">                account.setRemainingDays(account.getRemainingDays() + request.getWorkingDays());</span>
<span class="fc" id="L110">                accountRepository.save(account);</span>
<span class="fc" id="L111">                actionEmail = &quot;declined&quot;;</span>
            }

            try {
<span class="fc" id="L115">                emailService.sendEmail(new HolidayStatusUpdateEmail(request.getRequester(), actionEmail));</span>
<span class="fc" id="L116">                return holidayRequestRepository.save(request);</span>
<span class="fc" id="L117">            } catch (MailException e) {</span>
<span class="fc" id="L118">                throw new SystemException(&quot;There was a problem in the system!&quot;);</span>
            }
        }
<span class="fc" id="L121">        return null;</span>
    }


    public UploadedFile getFileOfRequest(String holidayRequestId) {
<span class="fc" id="L126">        return uploadedFileService.getFileByRequestId(holidayRequestId);</span>
    }

    public List&lt;HolidayRequest&gt; loadPendingHolidayRequestsForATeamLeader(String username) throws UserNotFoundException {
<span class="fc" id="L130">        Optional&lt;Account&gt; accountOptional = accountRepository.findByUsername(username);</span>
<span class="fc" id="L131">        return accountOptional.map(account -&gt; holidayRequestRepository.findAllByRequester_TeamLeaderAndStatus(account, RequestStatus.sentTL)).orElseThrow(() -&gt; new UserNotFoundException(&quot;User with username: &quot; + username + &quot; was not found!&quot;));</span>
    }

    public List&lt;HolidayRequest&gt; loadMyAcceptedHolidayRequests(String username) throws UserNotFoundException {
<span class="fc" id="L135">        return loadHolidayRequestsBasedOnUserAndStatus(username, RequestStatus.accTl);</span>
    }

    public List&lt;HolidayRequest&gt; loadMyDeclinedHolidayRequests(String username) throws UserNotFoundException {
<span class="fc" id="L139">        return loadHolidayRequestsBasedOnUserAndStatus(username, RequestStatus.decTL);</span>
    }

    public List&lt;HolidayRequest&gt; loadMyPendingHolidayRequests(String username) throws UserNotFoundException {
<span class="fc" id="L143">        return loadHolidayRequestsBasedOnUserAndStatus(username, RequestStatus.sentTL);</span>
    }

    private List&lt;HolidayRequest&gt; loadHolidayRequestsBasedOnUserAndStatus(String username, RequestStatus status) throws UserNotFoundException {
<span class="fc" id="L147">        Optional&lt;Account&gt; accountOptional = accountRepository.findByUsername(username);</span>
<span class="fc" id="L148">        return accountOptional.map(account -&gt; holidayRequestRepository.findAllByRequesterAndStatus(account, status)).orElseThrow(() -&gt; new UserNotFoundException(&quot;User with username: &quot; + username + &quot; was not found!&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>