<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ToM</a> &gt; <a href="index.source.html" class="el_package">ro.go.redhomeserver.tom.controllers</a> &gt; <span class="el_source">PasswordController.java</span></div><h1>PasswordController.java</h1><pre class="source lang-java linenums">package ro.go.redhomeserver.tom.controllers;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.springframework.web.servlet.view.RedirectView;
import ro.go.redhomeserver.tom.exceptions.*;
import ro.go.redhomeserver.tom.services.ActivationService;
import ro.go.redhomeserver.tom.services.PasswordService;

import javax.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

@Controller
public class PasswordController {

    private final PasswordService passwordService;
    private final ActivationService activationService;

    @Autowired
<span class="fc" id="L33">    public PasswordController(PasswordService passwordService, ActivationService activationService) {</span>
<span class="fc" id="L34">        this.passwordService = passwordService;</span>
<span class="fc" id="L35">        this.activationService = activationService;</span>
<span class="fc" id="L36">    }</span>

    @PostMapping(&quot;/reset-password&quot;)
    public RedirectView resetPassword(@RequestParam(&quot;username&quot;) String username, HttpServletRequest request, RedirectAttributes ra) {
<span class="nc" id="L40">        RedirectView rv = new RedirectView(&quot;/tom/log-in&quot;);</span>
<span class="nc" id="L41">        ra.addFlashAttribute(&quot;upperNotification&quot;, &quot;Check your email address!&quot;);</span>
        try {
<span class="nc" id="L43">            String hostLink = request.getScheme() + &quot;://&quot; + request.getServerName()+&quot;:8181/tom&quot;;</span>
<span class="nc" id="L44">            passwordService.addResetRequest(username, hostLink);</span>
<span class="nc" id="L45">        } catch (UserNotFoundException | SystemException e) {</span>
<span class="nc" id="L46">            ra.addFlashAttribute(&quot;upperNotification&quot;, e.getMessage());</span>
<span class="nc" id="L47">        }</span>
<span class="nc" id="L48">        return rv;</span>
    }

    @GetMapping(&quot;/validate-password-reset-request&quot;)
    public RedirectView validatePasswordResetRequest(@RequestParam(&quot;token&quot;) String token, RedirectAttributes ra) {
        RedirectView rv;
        try {
<span class="nc" id="L55">            rv = new RedirectView(&quot;/tom/set-new-password&quot;);</span>
<span class="nc" id="L56">            String id = passwordService.identifyAccountUsingToken(token);</span>
<span class="nc" id="L57">            ra.addFlashAttribute(&quot;userId&quot;, id);</span>
<span class="nc" id="L58">        } catch (InvalidTokenException e) {</span>
<span class="nc" id="L59">            rv = new RedirectView(&quot;/tom/log-in&quot;);</span>
<span class="nc" id="L60">            ra.addFlashAttribute(&quot;upperNotification&quot;, e.getMessage());</span>
<span class="nc" id="L61">        }</span>
<span class="nc" id="L62">        return rv;</span>
    }

    @GetMapping(&quot;/set-new-password&quot;)
    public ModelAndView setNewPassword(@ModelAttribute(&quot;userId&quot;) String id) {
<span class="nc" id="L67">        ModelAndView mv = new ModelAndView(&quot;reset-password&quot;);</span>
<span class="nc" id="L68">        mv.addObject(&quot;userId&quot;, id);</span>
<span class="nc" id="L69">        return mv;</span>
    }

    @PostMapping(&quot;/set-new-password&quot;)
    public ModelAndView setNewPassword(@RequestParam Map&lt;String, String&gt; data, @ModelAttribute(&quot;userId&quot;) String id, RedirectAttributes ra, Authentication authentication) {
<span class="nc" id="L74">        ModelAndView mv = new ModelAndView(&quot;reset-password&quot;);</span>
<span class="nc" id="L75">        mv.addObject(&quot;userId&quot;, id);</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (authentication != null) {</span>
<span class="nc" id="L78">            List&lt;GrantedAuthority&gt; updatedAuthorities = new ArrayList&lt;&gt;(authentication.getAuthorities());</span>
<span class="nc" id="L79">            updatedAuthorities.add(new SimpleGrantedAuthority(&quot;ACTIVATED&quot;));</span>
<span class="nc" id="L80">            Authentication newAuth = new UsernamePasswordAuthenticationToken(authentication.getPrincipal(), authentication.getCredentials(), updatedAuthorities);</span>
<span class="nc" id="L81">            SecurityContextHolder.getContext().setAuthentication(newAuth);</span>
        }

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (!activationService.isUserActivated(id))</span>
<span class="nc" id="L85">            activationService.activateMyAccount(id);</span>

        try {
<span class="nc" id="L88">            passwordService.validatePassword(data.get(&quot;password&quot;), data.get(&quot;passwordVerification&quot;));</span>
<span class="nc" id="L89">            passwordService.updateAccountPasswordById(data.get(&quot;userId&quot;), data.get(&quot;password&quot;));</span>
<span class="nc" id="L90">            mv = new ModelAndView(&quot;redirect:/log-in&quot;);</span>
<span class="nc" id="L91">            ra.addFlashAttribute(&quot;upperNotification&quot;, &quot;Password updated!&quot;);</span>
<span class="nc" id="L92">            return mv;</span>
<span class="nc" id="L93">        } catch (SignUpException e) {</span>
<span class="nc" id="L94">            mv.addObject(&quot;error&quot;, e.getMessage());</span>
        }
<span class="nc" id="L96">        return mv;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>