<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ToM</a> &gt; <a href="index.source.html" class="el_package">ro.go.redhomeserver.tom.services</a> &gt; <span class="el_source">PasswordService.java</span></div><h1>PasswordService.java</h1><pre class="source lang-java linenums">package ro.go.redhomeserver.tom.services;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.MailException;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import ro.go.redhomeserver.tom.emails.ResetPasswordEmail;
import ro.go.redhomeserver.tom.exceptions.*;
import ro.go.redhomeserver.tom.models.Account;
import ro.go.redhomeserver.tom.models.ResetPasswordRequest;
import ro.go.redhomeserver.tom.repositories.AccountRepository;
import ro.go.redhomeserver.tom.repositories.ResetPasswordRequestRepository;

import java.util.Calendar;
import java.util.Date;
import java.util.Optional;
import java.util.UUID;

@Service
public class PasswordService {

    private final EmailService emailService;
    private final ResetPasswordRequestRepository resetPasswordRequestRepository;
    private final PasswordEncoder passwordEncoder;
    private final AccountRepository accountRepository;

    @Autowired
<span class="fc" id="L28">    public PasswordService(EmailService emailService, ResetPasswordRequestRepository resetPasswordRequestRepository, PasswordEncoder passwordEncoder, AccountRepository accountRepository) {</span>
<span class="fc" id="L29">        this.accountRepository = accountRepository;</span>
<span class="fc" id="L30">        this.emailService = emailService;</span>
<span class="fc" id="L31">        this.resetPasswordRequestRepository = resetPasswordRequestRepository;</span>
<span class="fc" id="L32">        this.passwordEncoder = passwordEncoder;</span>
<span class="fc" id="L33">    }</span>

    public int validatePassword(String password, String verification) throws SignUpException {
<span class="fc bfc" id="L36" title="All 2 branches covered.">        if (!password.equals(verification))</span>
<span class="fc" id="L37">            throw new PasswordVerificationException(&quot;The password does not match!&quot;);</span>

<span class="fc" id="L39">        int iPasswordScore = 0;</span>

<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (password.matches(&quot;(?=.*[0-9]).*&quot;))</span>
<span class="fc" id="L42">            iPasswordScore += 2;</span>

<span class="pc bpc" id="L44" title="1 of 2 branches missed.">        if (password.matches(&quot;(?=.*[a-z]).*&quot;))</span>
<span class="fc" id="L45">            iPasswordScore += 2;</span>

<span class="fc bfc" id="L47" title="All 2 branches covered.">        if( password.matches(&quot;(?=.*[A-Z]).*&quot;) )</span>
<span class="fc" id="L48">            iPasswordScore += 2;</span>

<span class="fc bfc" id="L50" title="All 2 branches covered.">        if( password.matches(&quot;(?=.*[~!@#$%^&amp;*()_-]).*&quot;) )</span>
<span class="fc" id="L51">            iPasswordScore += 2;</span>

<span class="pc bpc" id="L53" title="1 of 4 branches missed.">        if (password.length() &lt; 8 || iPasswordScore &lt; 4)</span>
<span class="fc" id="L54">            throw new WeakPasswordException(&quot;The password is too weak!&quot;);</span>
<span class="fc" id="L55">        return iPasswordScore;</span>
    }

    public Account updateAccountPasswordById(String id, String password) throws SignUpException {
        try {
<span class="fc" id="L60">            Optional&lt;Account&gt; accountOptional = accountRepository.findById(id);</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">            if (!accountOptional.isPresent())</span>
<span class="fc" id="L62">                throw new UserNotFoundException(&quot;User was not found!&quot;);</span>
<span class="fc" id="L63">            Account account = accountOptional.get();</span>
<span class="fc" id="L64">            resetPasswordRequestRepository.deleteAllByAccount(account);</span>
<span class="fc" id="L65">            String saltedPass = password + account.getSalt();</span>
<span class="fc" id="L66">            account.setPassword(passwordEncoder.encode(saltedPass));</span>
<span class="fc" id="L67">            return accountRepository.save(account);</span>
<span class="fc" id="L68">        } catch (UserNotFoundException e) {</span>
<span class="fc" id="L69">            throw new SignUpException(&quot;There was an error in the sign up process!&quot;);</span>
        }
    }

    public String identifyAccountUsingToken(String token) throws InvalidTokenException {
<span class="fc" id="L74">        Date now = new Date();</span>
<span class="fc" id="L75">        Optional&lt;ResetPasswordRequest&gt; requestOptional = resetPasswordRequestRepository.findByToken(token);</span>
<span class="pc bpc" id="L76" title="1 of 4 branches missed.">        if(!requestOptional.isPresent() || requestOptional.get().getExpirationDate().compareTo(now) &lt; 0)</span>
<span class="fc" id="L77">            throw new InvalidTokenException(&quot;The token expired or is invalid!&quot;);</span>

<span class="fc" id="L79">        return requestOptional.get().getAccount().getId();</span>
    }

    public ResetPasswordRequest addResetRequest(String username, String hostLink) throws SystemException, UserNotFoundException {
        try {
<span class="fc" id="L84">            Optional&lt;Account&gt; accountOptional = accountRepository.findByUsername(username);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if(!accountOptional.isPresent())</span>
<span class="fc" id="L86">                throw new UserNotFoundException(&quot;User was not found!&quot;);</span>

<span class="fc" id="L88">            Account account = accountOptional.get();</span>
<span class="fc" id="L89">            Calendar calendar = Calendar.getInstance();</span>
<span class="fc" id="L90">            calendar.setTime(new Date());</span>
<span class="fc" id="L91">            calendar.add(Calendar.HOUR_OF_DAY, 1);</span>

<span class="fc" id="L93">            ResetPasswordRequest req = new ResetPasswordRequest(account, UUID.randomUUID().toString(), calendar.getTime());</span>
<span class="fc" id="L94">            ResetPasswordEmail data = new ResetPasswordEmail(account, hostLink + &quot;/validate-password-reset-request?token=&quot; + req.getToken());</span>
<span class="fc" id="L95">            emailService.sendEmail(data);</span>
<span class="fc" id="L96">            return resetPasswordRequestRepository.save(req);</span>
<span class="fc" id="L97">        } catch (MailException e) {</span>
<span class="fc" id="L98">            throw new SystemException(&quot;There was an error in sending the email!&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>